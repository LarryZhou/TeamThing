<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Web Dashboard | TeamThing</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link href="http://cdn.kendostatic.com/2012.1.322/styles/kendo.common.min.css" rel="stylesheet" />
    <link href="http://cdn.kendostatic.com/2012.1.322/styles/kendo.black.min.css" rel="stylesheet" />
    <link href="http://cdn.kendostatic.com/2012.1.322/styles/kendo.dataviz.min.css" rel="stylesheet" />
    <link href='http://fonts.googleapis.com/css?family=Reenie+Beanie' rel='stylesheet'
        type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
    <link href="/Content/html5bp.css" rel="stylesheet" />
    <link href="/Content/Site.css" rel="stylesheet" />
    <script src="/Scripts/modernizr-2.5.3.min.js"></script>
</head>
<body>
<div id="#dummy-output" style="color:#eee;">[Function Call Output]</div>
    <!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
    <div id="header" class="bkgnd-smooth-dark">
        <h1>TeamThing</h1>
         <div id="navigation" class="navigation">
            <!--<span data-bind="{text:user.EmailAddress}"></span>-->
            <a href="/my" class="k-button nav">
                Home</a>
             <a href="/logout" class="k-button nav">Logout</a>
        </div>
    </div>
    <div id="teamThing">
        <div id="appFrame">
        </div>
    </div>
    <div id="dialog" class="window">
    </div>
    <script type="text/x-kendo-tmpl" id="teamListTemplate">
        <div class="listItem teamListItem">
            <div class="commands">
             <!--   <a href="/team/#= team.id #" title="View Team" class="nav k-button k-view-button"><span class="k-icon k-search"></span></a>-->

                #if( userCanEditTeam() ) { #
                    <button class="k-button k-edit-button" title="Edit Team" data-bind="click:editTeam"><span class="k-icon k-edit"></span></button>
                    <button class="k-button k-delete-button" title="Delete Team" data-bind="click:removeTeam"><span class="k-icon k-delete"></span></button>
                # } #
            </div>
            <div class="details">
            <a href="/team/#= team.id #" title="View Team" data-bind="{text:team.name}" class="nav # if(team.isPublic) { #
                            publicTeam
                      # } else { #
                            closedTeam
                       # } #"/>
            </div>        
        </div>
    </script>
    <script type="text/x-kendo-tmpl" id="pendingTeamListTemplate">
        <div class="listItem teamListItem">
            <div class="commands">
             <!--   <a href="/team/#= team.id #" title="View Team" class="nav k-button k-view-button"><span class="k-icon k-search"></span></a>-->

                #if( userCanEditTeam() ) { #
                    <button class="k-button k-edit-button" title="Edit Team" data-bind="click:editTeam"><span class="k-icon k-edit"></span></button>
                    <button class="k-button k-delete-button" title="Delete Team" data-bind="click:removeTeam"><span class="k-icon k-delete"></span></button>
                # } #
            </div>
            <div class="details">
            <span data-bind="{text:team.name}" class="nav # if(team.isPublic) { #
                            publicTeam
                      # } else { #
                            closedTeam
                       # } #"/>
            </div>        
        </div>
    </script>
    <script type="text/x-kendo-tmpl" id="thingListTemplate">
        <div class="listItem thingListItem" data-role="droptarget">
            <div class="commands">
                <button class="k-button k-view-button" title="View Thing" data-bind="click:view"><span class="k-icon k-search"></span></button>

                 #if(!isDone()) { #
                     #if( userCanComplete() ) { #
                        <button class="k-button k-complete-button" title="Complete Thing" data-bind="click:complete"><span class="k-icon k-update"></span></button>
                    # } #
                    #if( userCanEdit() ) { #
                        <button class="k-button k-edit-button" title="Edit Thing" data-bind="click:edit"><span class="k-icon k-edit"></span></button>
                    # } #
                    #if( userCanRemove() ) { #
                        <button class="k-button k-delete-button" title="Delete Thing" data-bind="click:remove"><span class="k-icon k-delete"></span></button>
                    # } #
                # } #
            </div>
            <div class="details">
                <span data-bind="{text:thing.description}" class="info"/>
            </div>
        </div>
    </script>
    <script type="text/x-kendo-tmpl" id="teamUserListTemplate">
        <div class="listItem userListItem" data-role="draggable" data-draggable-hint="hint" data-hint="hint">
            <div class="commands">
                <button class="k-button k-edit-button" title="Edit Team Memeber" data-bind="click:editUser"><span class="k-icon k-edit"></span></button>
                # if( userCanApprove()) { #
                    <button class="k-button k-delete-button" title="Remove Team Member" data-bind="click:denyUser"><span class="k-icon k-cancel"></span></button>
                # } #
            </div>
            <div class="details user">
                <img data-bind="{attr:{src:user.imagePath}}"/>
                <span data-bind="{text:user.emailAddress}" class="info"/>
            </div>
        </div>
    </script>
    <script type="text/x-kendo-tmpl" id="teamPendingUserListTemplate">
        <div class="listItem pendingUserListItem">
            <div class="commands">
                # if( userCanApprove() ) { #
                        <button class="k-button k-view-button" title="Approve User" data-bind="click:approveUser"><span class="k-icon k-update"></span></button>
                        <button class="k-button k-delete-button" title="Deny User" data-bind="click:denyUser"><span class="k-icon k-cancel"></span></button>
                # } #
            </div>
            <div class="details user">
                <img data-bind="{attr:{src:user.imagePath}}" class="image"/>
                <span data-bind="{text:user.emailAddress}" class="info"/>
            </div>
        </div>
    </script>
    <script type="text/x-kendo-tmpl" id="userSignInTemplate">
        <div id="userLogin">
        <h2>Please Login</h2>
            <ol class="formFieldList">
                <!--<li>
                    <input id="userName" type="text" data-bind="value:userName" class="k-textbox" />
                </li>-->
                <li class="commands">
                   <!--<button class="k-button" data-bind="click:registerUser">Register</button>-->
                    <!--<button class="k-button" data-bind="click:signInUser">Sign In</button>-->
                    <div>
                        <button class="k-button" data-bind="click:connectUserWithFacebook">Facebook</button>
                        <button class="k-button" data-bind="click:connectUserWithGoogle">Google</button>
                    </div>
                </li>
            </ol>
        </div>
    </script>
    <script type="text/x-kendo-tmpl" id="teamDashboardTemplate">
       <div id="teamDashboard">
            <h2 data-bind="text:team.name">
            </h2>

            <div id="right">
                <h3>Team Members</h3>
               
                <div data-role="tabstrip">
                    <ul>
                      <li class="k-state-active">Approved</li>
                      #if(pendingTeamMembers.length > 0 ) { #
                          <li>Pending</li>
                      # } #
                    </ul>
                    <div id="teamUserList" data-template="teamUserListTemplate" data-role="listview" data-bind="source:teamMembers">
                    </div>
                    #if(pendingTeamMembers.length > 0 ) { #
                        <div id="teamPendingUserList" data-template="teamPendingUserListTemplate" data-role="listview" data-bind="source:pendingTeamMembers">
                        </div>
                    # } #
                </div>
            </div>
            <div id="left">
               <h3>Team Things</h3>
                <div class="listCommands">
                    # if(thingList.completedThings.length > 0 || thingList.activeThings.length > 0 ) { #
                        <button class="k-button k-add-button" data-bind="click:addThing" title="Create a Thing">
                            <span class="k-icon k-add"></span>
                        </button> 
                    # } #
                </div>
                <div data-role="tabstrip">
                        # if(thingList.completedThings.length > 0 || thingList.activeThings.length > 0 ) { #
                            <ul>
                                #if(thingList.activeThings.length > 0 ) { #
                                    <li class="k-state-active">Active</li>
                                # } #
                                #if(thingList.completedThings.length > 0 ) { #
                                    <li
                                     #if(thingList.activeThings.length == 0 ) { #
                                        class="k-state-active"
                                     # } #
                                    >Completed</li>
                                # } #
                            </ul>
                        #if(thingList.activeThings.length > 0 ) { #
                            <div id="activeThings" data-template="thingListTemplate" data-role="listview"  data-bind="source:thingList.activeThings">
                            </div>
                        # } #
                        #if(thingList.completedThings.length > 0 ) { #
                            <div id="completedThings" data-template="thingListTemplate" data-role="listview" data-bind="source:thingList.completedThings">
                            </div>
                        # } #
                     # } else { #
                        <br/><!---Yea its a br...deal with it :)--->
                        <em>Nothing to do yet! </em>
                        <br/>
                         <button data-bind="click:addThing" class="k-button">
                            Add a Thing
                        </button> 
                     # } #
                </div>
            </div>
        </div>
    </script>
    <script type="text/x-kendo-tmpl" id="noTeamsTemplate">
    <div>
        <br/><!---Yea its a br...deal with it :)--->
        <em>You Have Not Joined Any Teams, yet!</em>
        <br/>
        <a data-bind="click:createTeam">
            Create a Team
        </a> 
        <a data-bind="click:joinTeam">
            Join a Team
        </a>
    </div>
    </script>
    <script type="text/x-kendo-tmpl" id="userDashboardTemplate">
        <div id="userDashboard">
            <div class="subHeader clearfix">
                <img class="" data-bind="attr:{src:user.imagePath}"/>
                <h2 data-bind="text:user.emailAddress">                    
                </h2>
           </div>
            <div id="right">
                <h3>My Teams</h3>
                  #if( pendingTeams.length > 0 || teams.length > 0 ) { #
                      <div class="listCommands">
                        <button class="k-button k-add-button" data-bind="click:createTeam" title="Create a Team">
                            <span class="k-icon k-add"></span>
                        </button> 
                        <button class="k-button k-createLink-button" data-bind="click:joinTeam" title="Join a Team">
                            <span class="k-icon k-createLink"></span>
                        </button>
                    </div>
                    <div data-role="tabstrip">
                        <ul>
                            <li class="k-state-active">Active</li>
                            #if(pendingTeams.length > 0 ) { #
                                <li>Pending</li>
                            # } #
                        </ul>
                        <div id="teamListView" class="teamListView" data-template="teamListTemplate" data-role="listview" data-bind="source:teams">
                        </div>
                        #if(pendingTeams.length > 0 ) { #
                            <div id="pendingTeamListView" class="pendingTeamListView" data-template="pendingTeamListTemplate" data-role="listview" data-bind="source:pendingTeams">
                            </div>
                        # } #
                    </div>
                # } else { #
                    <!---Nested Template doesn't work!--->
                      <div>
                       <br/><!---Yea its a br...deal with it :)--->
                        <em>You Have Not Joined Any Teams, yet!</em>
                        <br/>
                        <button data-bind="click:createTeam" class="k-button">
                            Create a Team
                        </button> &nbsp;
                        <button data-bind="click:joinTeam" class="k-button">
                            Join a Team
                        </button>
                    </div>
                # } #
            </div>
            <div id="left">
                <h3>My Things</h3>
                  <div data-role="tabstrip">
                        # if(thingList.completedThings.length > 0 || thingList.activeThings.length > 0 ) { #
                            <ul>
                                #if(thingList.activeThings.length > 0 ) { #
                                    <li class="k-state-active">Active</li>
                                # } #
                                #if(thingList.completedThings.length > 0 ) { #
                                    <li
                                     #if(thingList.activeThings.length == 0 ) { #
                                        class="k-state-active"
                                     # } #
                                    >Completed</li>
                                # } #
                            </ul>
                        #if(thingList.activeThings.length > 0 ) { #
                            <div id="activeThings" data-template="thingListTemplate" data-role="listview"  data-bind="source:thingList.activeThings">
                            </div>
                        # } #
                        #if(thingList.completedThings.length > 0 ) { #
                            <div id="completedThings" data-template="thingListTemplate" data-role="listview" data-bind="source:thingList.completedThings">
                            </div>
                        # } #
                     # } else { #
                        <br/>
                        <em>Nothing to do yet! </em>
                     # } #
                </div>
            </div>
        </div>
    </script>
</body>
<script src="/Scripts/path.min.js"></script>
<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
<script src="http://cdn.kendostatic.com/2012.1.322/js/kendo.all.min.js"></script>    
<script src="/Scripts/oAuthProvider.js"></script>
<script src="/Scripts/dataProvider.js"></script>
<script>
    $(function () {
       teamThing.init($("#teamThing"));
		
		APPURL = 'http://teamthing.apphb.com';
		
		$.get(
    		APPURL+'/api/user?$filter=EmailAddress ne null and tolower(EmailAddress) eq \'jholt456@gmail.com\'',
    		function(data) { 
				console.log(data);
				$('#dummy-output').append(data);
			}
		);
		
    });
</script>
<script type="text/javascript">
(function (application, $, kendo, undefined) {
    "use strict";
    var application;

    function TeamDashboard(team) {
        var that = this;
        this.team = team;

        this.pendingTeamMembers = $.map(team.pendingTeamMembers, function (member) {
            return new PendingMemberListItemViewModel(member, that);
        });

        this.teamMembers = $.map(team.teamMembers, function (member) {
            return new TeamMemberListItemViewModel(member, that);
        });

        this.thingList = new ThingListViewModel(this, team);

        this.refresh = function () {
            //TODO: Memory leak?!?
            application.showTeam(that.team);  
        }

        function thingAdded(thing) {
            that.team.things.push(thing);
            that.refresh();
        }

        function memberApproved(user) {
            that.team.teamMembers.push(user);
            that.team.pendingTeamMembers = $.grep(that.team.pendingTeamMembers, function (e) { return e.id != user.id });
            that.refresh();
        }

        this.userIsAdmin = function (user) {
            return true; //TODO: check if passed user is an admin for the team
        };

        this.editMember = function (user) {
            alert("edit" + user.id);
        };

        this.viewMember = function (user) {
            alert("view" + user.id);
        };

        this.denyMember = function (user) {

            var teamId = that.team.id;
            var approvalInfo = { userId: user.id };

            //ToDO: will this cause a memory leak?!
            application.dataProvider.updateResource("/api/team/" + teamId + "/denymember", approvalInfo, this.refresh);
        };

        this.approveMember = function (user) {
            var teamId = that.team.id;
            var approvalInfo = { userId: user.id };

            //ToDO: will this cause a memory leak?!
            application.dataProvider.updateResource("/api/team/" + teamId + "/approvemember", approvalInfo, function () {
                memberApproved(user);
            });
        };

        this.addThing = function () {

            var newThingModel = {
                description: "",
                availableTeamMembers: that.team.teamMembers,
                selectedTeamMembers: [],
                save: function (e) {

                    //get the current application user's id
                    var currentUserId = application.user.id;
                    var assignedTo = $.map(this.selectedTeamMembers, function (member) { return member.id });

                    var vm = this;
                    //create the thing object
                    var thing = { createdById: currentUserId, description: this.description, assignedTo: assignedTo, teamId: that.team.id };

                    //save the new thing back to the server
                    application.dataProvider.createResource("/api/thing", thing, function (result) {
                        application.closeDialog(); //ewww
                        thingAdded(result);
                    });
                },
                cancel: function (e) {
                    application.closeDialog(); //ewww
                }
            };

            application.showDialog("#thingEditor", "Add a Thing", "/thingEditor.html", newThingModel);
        };

        return this;
    }

    function UserDashboard(_user) {
        var that = this;
        this.user = _user;

        function toogleUI() {
            //if the user only has one team, show that teams info!
            if (that.teams.length === 1) {
                that.viewTeam(that.teams[0].id);
            }
        };

        function teamUpdated(team) {
            //TODO: Update team info in UI

            var teams = that.user.teams;
            var i = teams.length;
            while (i--) {
                var currentTeam = teams[i];
                if (currentTeam.id == team.id) {
                    teams[i] = team;
                }
            }
            that.refresh();
        }

        function teamCreated(team) {
            that.user.teams.push(team);
            that.refresh();
        }

        this.refresh = function () {
            //TODO: Memory leak?!?
            application.loadUser(that.user);
        }

        function teamRemoved(removedTeam) {

            that.user.teams = $.grep(that.user.teams, function (e) { return e.id != removedTeam.id });
            that.refresh();
        }

        function teamJoined(team) {
            if (team.isPublic) {
                that.user.teams.push(team);
            }
            else {
                that.user.pendingTeams.push(team);
            }

            that.refresh();
        };

        this.joinTeam = function () {

            var joinTeamViewModel = kendo.observable({
                name: "",
                canSave: false,
                foundTeamId: 0,
                searchStatusClass: 'ok',
                searchStatusMessage: '',
                searchTeams: function (e) {
                    var searchedName = this.name;
                    var vm = this;
                    //TODO: instead of an exact match we could let users se how many partials matches there are?
                    application.dataProvider.get("/api/team?$filter=Name ne null and tolower(Name) eq '" + searchedName.toLowerCase() + "'", function (result) {

                        if (result.length > 0) {
                            vm.set('canSave', true);
                            vm.set('searchStatusClass', 'searchResult ok');
                            vm.set('searchStatusMessage', 'Team Found');
                            vm.set('foundTeamId', result[0].id);
                        }
                        else {
                            vm.set('canSave', false);
                            vm.set('searchStatusClass', 'searchResult error');
                            vm.set('searchStatusMessage', "No Team Found");
                            vm.set('foundTeamId', 0);
                        }
                    });
                },
                save: function (e) {

                    //get the current application user's id
                    var currentUserId = application.user.id;

                    //create the team object
                    var team = { userId: currentUserId, id: this.foundTeamId };
                    var vm = this;
                    //save the new team back to the server
                    application.dataProvider.updateResource("/api/team/" + this.foundTeamId + "/join", team, function (result) {
                        application.closeDialog(); //ewww
                        teamJoined(result);
                    });
                },
                cancel: function (e) {
                    application.closeDialog(); //ewww
                }
            });

            application.showDialog("#joinTeam", "Join a Team", "/joinTeam.html", joinTeamViewModel);
        };

        this.removeTeam = function (team) {
            if (confirm("SRSLY?")) {
                var currentUserId = application.user.id;
                var vm = { userId: currentUserId };
                application.dataProvider.removeResource('/api/team/' + team.id, vm, function () {
                    teamRemoved(team);
                });
            }
        };

        this.editTeam = function (team) {

            var teamEditorViewModel = {
                name: team.name,
                id: team.id,
                isPublic: team.isPublic,
                canSave: true,
                searchStatusClass: 'ok',
                searchStatusMessage: '',
                searchTeams: function (e) {
                    var searchedName = this.name;
                    var vm = this;
                    //TODO: instead of an exact match we could let users se how many partials matches there are?
                    application.dataProvider.get("/api/team?$filter=Name ne null and tolower(Name) eq '" + searchedName.toLowerCase() + "'", function (result) {

                        if (result.length > 0 && result[0].id != vm.id) {
                            vm.set('canSave', false);
                            vm.set('searchStatusClass', 'searchResult error');
                            vm.set('searchStatusMessage', 'Team Name Not Available');
                        }
                        else if (result.length > 0 && result[0].id == vm.id) {
                            vm.set('canSave', true);
                            vm.set('searchStatusClass', 'searchResult ok');
                            vm.set('searchStatusMessage', '');
                        }
                        else {
                            vm.set('canSave', true);
                            vm.set('searchStatusClass', 'searchResult ok');
                            vm.set('searchStatusMessage', "Team Name Available");
                        }
                    });
                },
                save: function (e) {

                    //get the current application user's id
                    var currentUserId = application.user.id;

                    var editedTeam = { id: this.id, name: this.name, ispublic: this.isPublic, updatedbyid: currentUserId };
                    var vm = this;
                    //save the new thing back to the server
                    application.dataProvider.updateResource("/api/team/" + editedTeam.id, editedTeam, function (result) {
                        application.closeDialog(); //ewww
                        teamUpdated(result);
                    });
                },
                cancel: function (e) {
                    application.closeDialog(); //ewww
                }
            };

            application.showDialog("#newTeam", "Edit Team", "/teamEditor.html", teamEditorViewModel);
        };

        this.createTeam = function () {

            var newTeamViewModel = {
                name: "",
                isPublic: false,
                canSave: false,
                searchStatusClass: 'noResults',
                searchStatusMessage: '',
                searchTeams: function (e) {

                    var searchedName = this.name;
                    var vm = this;
                    //TODO: instead of an exact match we could let users se how many partials matches there are?
                    application.dataProvider.get("/api/team?$filter=Name ne null and tolower(Name) eq '" + searchedName.toLowerCase() + "'", function (result) {

                        if (result.length > 0) {
                            vm.set('canSave', false);
                            vm.set('searchStatusClass', 'searchResult error');
                            vm.set('searchStatusMessage', 'Team Name Not Available');
                        }
                        else {
                            vm.set('canSave', true);
                            vm.set('searchStatusClass', 'searchResult ok');
                            vm.set('searchStatusMessage', "Team Name Available");
                        }
                    });
                },
                save: function (e) {

                    //get the current application user's id
                    var currentUserId = application.user.id;

                    //create the thing object
                    var team = { name: this.name, ispublic: this.isPublic, createdById: currentUserId };

                    //save the new thing back to the server
                    application.dataProvider.createResource("/api/team", team, function (result) {
                        application.closeDialog(); //ewww
                        teamCreated(result);
                    });
                },
                cancel: function (e) {
                    application.closeDialog(); //ewww
                }
            };

            application.showDialog("#newTeam", "Create a New Team", "/teamEditor.html", newTeamViewModel);
        };

        this.viewTeam = function (id) {
            //todo: this is kinda ugly
            application.dataProvider.get("api/team/" + id, application.showTeam);
        };

        this.teams = $.map(this.user.teams, function (team) {
            return new TeamListItemViewModel(team, that);
        });

        this.pendingTeams = $.map(this.user.pendingTeams, function (team) {
            return new TeamListItemViewModel(team, that);
        });

        this.thingList = new ThingListViewModel(this, this.user);

        return this;
    }

    function ThingListViewModel(parent, _thingContainer) {

        var that = this;
        var things = _thingContainer.things;
        var thingContainer = _thingContainer;

        var activeThings = things.filter(function (t) {
            return t.status == "InProgress";
        });
        var completedThings = things.filter(function (t) {
            return t.status == "Completed";
        });

        this.allTheThings = $.map(things, createThingViewModel);
        this.activeThings = $.map(activeThings, createThingViewModel);
        this.completedThings = $.map(completedThings, createThingViewModel);

        function createThingViewModel(thing) {
            return new ThingListItemViewModel(thing, that);
        }

        function thingAdded(thing) {
            thingContainer.things.push(thing);
            parent.refresh();
        }

        function thingRemoved(thing) {
            thingContainer.things = $.grep(thingContainer.things, function (e) { return e.id != thing.id });
            parent.refresh();
        }

        function thingUpdated(thing) {

            var i = thingContainer.things.length;
            while (i--) {
                var current = thingContainer.things[i];
                if (current.id == thing.id) {
                    thingContainer.things[i] = thing;
                }
            }
            parent.refresh();
        }

        this.edit = function (editedThing) {

            application.dataProvider.get("/api/team/" + editedThing.team.id, function (result) {
                var thingEditModel = {
                    description: editedThing.description,
                    availableTeamMembers: result.teamMembers,
                    selectedTeamMembers: $.map(editedThing.assignedTo, function (member) { return member }),
                    save: function (e) {

                        //get the current application user's id
                        var currentUserId = application.user.id;

                        var assignedTo = $.map(this.selectedTeamMembers, function (member) { return member.id });

                        //create the thing object
                        var thing = { editedById: currentUserId, description: this.description, assignedTo: assignedTo, id: editedThing.id };

                        //save the new thing back to the server
                        application.dataProvider.updateResource("/api/thing/" + editedThing.id, thing, function (result) {
                            application.closeDialog(); //ewww
                            thingUpdated(result);
                        });
                    },
                    cancel: function (e) {
                        application.closeDialog(); //ewww
                    }
                };

                application.showDialog("#thingEditor", "Edit a Thing", "/thingEditor.html", thingEditModel);
            });

        };
        this.remove = function (thing) {
            if (confirm("SRSLY?")) {
                var currentUserId = application.user.id;
                application.dataProvider.removeResource('/api/thing/' + thing.id, { deletedById: currentUserId, id: thing.id }, function () {
                    thingRemoved(thing);
                });
            }
        };
        this.complete = function (thing) {
            if (confirm("SRSLY?")) {
                var vm = { id: thing.id, userId: application.user.id };
                application.dataProvider.updateResource('/api/thing/' + thing.id + '/complete', vm, function (result) {
                    thingUpdated(result);
                });
            }
        };
        this.view = function (thing) {
            alert("view" + thing.id);
        };

        return this;
    }

    function ThingListItemViewModel(_thing, thingListViewModel) {

        var parent = thingListViewModel;
        this.thing = _thing;

        this.edit = function (e) { parent.edit(this.thing); };
        this.view = function (e) { parent.view(this.thing); };
        this.remove = function (e) { parent.remove(this.thing); };
        this.complete = function (e) { parent.complete(this.thing); };

        this.isDone = function () {
            return this.thing.status == "Completed";
        };

        this.userCanEdit = function () {
            var applicationUser = application.user;
            var assignedUsers = $.map(this.thing.assignedTo, function (user) {
                return user.id;
            });

            if (this.isDone == true) {
                return false;
            }

            //if (applicationUser != null && (this.thing.OwnerId === applicationUser.Id || $.inArray(applicationUser.Id, assignedUsers) != -1)) {
            if (applicationUser != null && this.thing.owner.id === applicationUser.id) {
                return true;
            }
            return false;
        };
        this.userCanRemove = function () {
            var applicationUser = application.user;

            if (this.isDone == true) {
                return false;
            }

            if (applicationUser != null && this.thing.owner.id === applicationUser.id) {
                return true;
            }
            return false;
        };
        this.userCanComplete = function () {
            var applicationUser = application.user;

            if (this.isDone == true) {
                return false;
            }

            var assignedToIds = $.map(this.thing.assignedTo, function (thingMember) {
                return thingMember.id;
            });

            if (applicationUser != null && $.inArray(applicationUser.id, assignedToIds) != -1) {
                return true;
            }
            return false;
        };

        return this;
    }

    function TeamListItemViewModel(team, userController) {

        var user = application.user;
        var parent = userController;

        this.team = team;

        this.editTeam = function (e) { parent.editTeam(this.team); };
        this.removeTeam = function (e) { parent.removeTeam(this.team); };


        this.userCanEditTeam = function () {
            if (user != null && (this.team.ownerId === user.id || $.inArray(user.id, this.team.administrators) != -1)) {
                return true;
            }
            return false;
        };

        this.userCanViewTeam = function () {
            //TODO: check user team status
            return true;
        };
    }

    function PendingMemberListItemViewModel(pendingMember, teamController) {
        var parent = teamController;
        this.user = pendingMember;

        this.approveUser = function (e) { parent.approveMember(this.user); };
        this.denyUser = function (e) { parent.denyMember(this.user); };

        this.userCanApprove = function () {

            if (parent.userIsAdmin(application.user)) {
                return true;
            }

            return false;
        };
    }

    function TeamMemberListItemViewModel(user, teamController) {
        var parent = teamController;
        this.user = user;

        this.viewUser = function (e) { parent.viewMember(this.user); };
        this.editUser = function (e) { parent.editMember(this.user); };
        this.denyUser = function (e) { parent.denyMember(this.user); };
        this.hint = function (element) {
            return element.clone();
        }
        this.userCanApprove = function () {

            if (parent.userIsAdmin(application.user) || user.id == application.user.id) {
                return true;
            }

            return false;
        };

        //this.userCanBeDenied = function () {

        //    if (parent.userIsAdmin(application.user) || user.id != application.user.id) {
        //        return true;
        //    }

        //    return false;
        //};
    }

    function SignInViewModel() {
        this.userName = "";
        var that = this;

        function validateInput() {
            var minUserNameLength = 7; //'@.xxx'

            //TODO: that should be changed to this after release
            if (that.userName.length <= minUserNameLength) {
                alert("User name must be greater than " + minUserNameLength + " characters");
                return false;
            }

            return true;
        }

        function userLoaded(user) {

            if (user != null) {
                application.user = user;
                application.loadUser(user);
            }
        }

        this.signInUser = function () {
            if (validateInput()) {
                //TODO: that should be changed to this after release
                var userInfo = { EmailAddress: that.userName };
                //todo: this is kinda ugly
                application.dataProvider.post("/api/user/signin", userInfo, userLoaded);
            }
        };

        this.signIn = function (authToken, provider) {
            var userInfo = { Provider: provider, AuthToken: authToken };
            application.dataProvider.post("/api/user/oauth", userInfo, userLoaded);
        };

        //this.getUserInfo = function(auth) {
        //    $.ajax({ url: resourceHost + '/userinfo?access_token=' + token
        //            , beforeSend: function (xhr) {
        //                xhr.setRequestHeader('Authorization', "Bearer " + token);
        //                xhr.setRequestHeader('Accept', "application/json");
        //            },
        //            success: function (response) {
        //                var container = $('span.user');
        //                if (response) {
        //                    container.text(response.name + ", " + response.email + ", "+ response.id);
        //                } else {
        //                    container.text("An error occurred.");
        //                }
        //            });
        //};

        this.connectUserWithFacebook = function () {


            var auth = new OAuthProvider(null);
            auth.signIn('facebook');
            ////TODO: that should be changed to this after release
            //var userInfo = { EmailAddress: that.userName };
            ////todo: this is kinda ugly
            //application.dataProvider.post("/api/user/openidAuth?provider=facebook", userInfo, userLoaded);

        };

        this.connectUserWithGoogle = function () {
            var auth = new OAuthProvider(null);
            auth.signIn('google');
            //location.href = "https://accounts.google.com/o/oauth2/auth?state=authHandled&response_type=token&client_id=1071592151045.apps.googleusercontent.com&redirect_uri=http://localhost:5079/&scope=https://www.googleapis.com/auth/userinfo.profile+https://www.googleapis.com/auth/userinfo.email";
        };

        this.registerUser = function () {
            if (validateInput()) {
                //TODO: that should be changed to this after release
                var userInfo = { emailAddress: that.userName };
                //todo: this is kinda ugly
                application.dataProvider.createResource("/api/user/register", userInfo, userLoaded);
            }
        };

        return this;
    }

    function TeamThingApplication(_context) {
        this.authProvider;
        this.dataProvider;
        this.user = null;

        var dialog;
        var views = [];
        var isOnline;
        var context = _context;
        var that = this;
        var activeUserViewModel; //TODO: get rid of this

        this.appViewModel = {
            user: null
        };

        function changeContent(templateName, viewModel) {

            //cache caused issues (maybe force a refresh?) also need to include an identifier in the cache key
            //if (views[templateName] == null) {
            //var template = kendo.template($("#" + templateName).html());
            var compiledTemplate = that.compileTemplate(templateName, viewModel);
            views[templateName] = compiledTemplate;
            //            }
            //            else {
            //                compiledTemplate = views[templateName];
            //            }

            $("#appFrame").html(compiledTemplate);
        }

        function createDialog() {
            if (dialog == null) {
                var windowEl = $("#dialog");

                if (!windowEl.data("kendoWindow")) {
                    dialog = windowEl.kendoWindow({
                        actions: ["Close"],
                        draggable: true,
                        modal: true,
                        resizable: false
                    });

                    windowEl.show();
                }
            }

            return dialog;
        };

        this.closeDialog = function () {
            if (dialog != null) {
                kendo.unbind($(dialog.selector), dialog.viewModel);
                var window = dialog.data("kendoWindow");
                window.content(' ') //empty string does not work, it still returns the content
                      .close();
            }
        };

        //TODO: maybe we should move the binding outside of this?!
        this.showDialog = function (bindingTargetSelector, title, url, viewModel) {

            var dialog = createDialog();
            dialog.binding = {
                selector: bindingTargetSelector,
                viewModel: viewModel
            };

            var window = dialog.data("kendoWindow");

            var refreshCallback = function () {
                window.unbind('refresh', refreshCallback);
                kendo.bind($(bindingTargetSelector), viewModel);
            };

            window.bind("refresh", refreshCallback);
            //todo: bind on close to unbind view model?
            window.refresh({ url: url })
                  .title(title)
                  .center()
                  .open();

            return window;
        };

        this.compileTemplate = function (templateName, viewModel) {
            var template = kendo.template($("#" + templateName).html());
            return template(viewModel);
        };

        this.showTeam = function (team) {
            //We need to unbind this
            var teamViewModel = new TeamDashboard(team);
            changeContent("teamDashboardTemplate", teamViewModel);
            kendo.bind($("#teamDashboard"), teamViewModel);
        };

        this.showLogin = function () {

            var authProviderStatus = that.authProvider.getStatus();
            var signInViewModel = new SignInViewModel(that);
            if (authProviderStatus.signedIn) {
                signInViewModel.signIn(authProviderStatus.accessToken, authProviderStatus.provider);
            }
            else {

                changeContent("userSignInTemplate", signInViewModel);
                kendo.bind($("#userLogin"), signInViewModel);

                $('#navigation').hide(); //TODO: should be able to do style binding?

                //TODO: remove this after the release as you will be able to bind in templates :)
                $("#userLogin").delegate("#userName", "change", function () {
                    signInViewModel.userName = this.value;
                });
            }
        };

        //        this.previous = function () {
        //            //$("#appFrame").html(views.pop());
        //        };
        //        this.forward = function () {
        //            //$("#appFrame").html(views.p());
        //        };

        this.showErrors = function (errors) {
            var strErrors = "";
            if ($.isArray(errors)) {
                $.each(errors, function (index, err) {
                    strErrors += "*" + err + "\n";
                });
            }
            else {
                strErrors = errors;
            }
            alert(strErrors);
        };

        this.loadUser = function (user) {

            if (activeUserViewModel != null) {
                kendo.unbind($("#userDashboard"), activeUserViewModel);
            }

            activeUserViewModel = new UserDashboard(user);
            changeContent("userDashboardTemplate", activeUserViewModel);

            $('#navigation').show(); //TODO: should be able to do style binding?

            kendo.bind($("#userDashboard"), activeUserViewModel);
        };

        this.init = function () {

            kendo.bind(context, that);

            configureRoutes();
            configureDataProvider();
            configureConnectivityDetection();
            configureAuthProvider();

            that.showLogin();
        };

        function configureDataProvider() {
            that.dataProvider = new DataProvider(that.showErrors);
        }

        function configureAuthProvider() {
            that.authProvider = new OAuthProvider();
        }

        function connectivityChanged() {
            //TODO: here would swap out the data provider, and wire up some sync operations if needed
            if (navigator.onLine) {
                alert('online');
            }
            else {
                alert('offline');
            }
        }

        function configureConnectivityDetection() {
            setInterval(function () {
                if (isOnline != null && navigator.onLine != isOnline) {
                    connectivityChanged();
                }

                isOnline = navigator.onLine;
            }, 1000);
        }

        function configureRoutes() {

            // Here we define our routes.  You'll notice that I only define three routes, even
            // though there are four links.  Each route has an action assigned to it (via the
            // `to` method, as well as an `enter` method.  The `enter` method is called before
            // the route is performed, which allows you to do any setup you need (changes classes,
            // performing AJAX calls, adding animations, etc.
            Path.map("/my").to(function () {
                that.dataProvider.get('/api/user/' + activeUserViewModel.user.id, that.loadUser);
            }).enter(function () {
                if (activeUserViewModel == null) {
                    that.showLogin();
                    return false;
                }
            });

            Path.map("/logout").to(function () {
                location.href = Path.history.initial.URL;
            });

            Path.map("/team/:teamId").to(function () {
                that.dataProvider.get('/api/team/' + this.params["teamId"], that.showTeam);
            }).enter(function () {
                if (activeUserViewModel == null) {
                    that.showLogin();
                    return false;
                }
            });


            Path.map("/").to(function () {
                Path.root("/");
                that.showLogin();
                return false;
            });

            Path.map("/go9media.html").to(function () {
                Path.root("/go9media.html");
                that.showLogin();
                return false;
            });



            Path.rescue(notFound);

            Path.history.listen();

            $('body').on('click', 'a.nav', function (event) {
                event.preventDefault();
                Path.history.pushState({}, "", $(this).attr("href"));
            });
        }

        function notFound() {
            alert("BAD PAGE DOOODE");
        }

        //init(context);
        return this;
    }

    teamThing.init = function ($contextEl) {
        application = new TeamThingApplication($contextEl);
        application.init();
    }

    return teamThing;

}(window.teamThing = window.teamThing || {}, jQuery, kendo));
</script>

</html>
